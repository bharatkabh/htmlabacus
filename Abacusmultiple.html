<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multi-Abacus Tool</title>
    <style>
        :root {
            --background-color: #f0f2f5;
            --frame-color: #ffffff;
            --rod-color: #d1d5db;
            --bar-color: #4b5563;
            --earth-bead-color: #2563eb;
            --heaven-bead-color: #16a34a;
            --highlight-color: #60a5fa;
            --text-color: #111827;
            --bead-size: 40px;
            --bead-margin: 5px;
            --rod-width: 6px;
            --bar-height: 20px;
            --bead-move-distance: 48px;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px 10px;
            /* Allow scrolling for multiple abacuses */
            overflow-y: auto;
            touch-action: manipulation;
        }
        
        /* --- Controls for Add/Remove --- */
        #app-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--bar-color);
            background-color: var(--frame-color);
            color: var(--bar-color);
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.15s ease, background-color 0.15s ease;
        }
        
        .control-btn:hover {
            background-color: #e5e7eb;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* Container for all abacus instances */
        #abacus-collection {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px; /* Space between multiple abacuses */
        }

        .abacus-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            width: 100%;
            max-width: 800px;
        }

        /* --- Switched from ID to class for reusability --- */
        .result-display {
            background-color: var(--frame-color);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 2.5em;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 25px;
            width: 100%;
            max-width: 600px;
            text-align: right;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            letter-spacing: 2px;
            box-sizing: border-box;
        }

        .abacus-frame {
            display: flex;
            justify-content: space-around;
            background-color: var(--frame-color);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px 10px;
            width: 100%;
            height: 320px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .center-bar {
            position: absolute;
            width: 100%;
            height: var(--bar-height);
            background-color: var(--bar-color);
            top: 30%;
            left: 0;
            z-index: 1;
            border-radius: 6px;
        }

        .rod {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            width: var(--rod-width);
            height: 100%;
            background-color: var(--rod-color);
            border-radius: 3px;
            position: relative;
        }
        
        .upper-deck, .lower-deck {
            display: flex;
            flex-direction: column;
        }
        .upper-deck { height: 30%; justify-content: flex-start; }
        .lower-deck { height: 70%; justify-content: flex-end; padding-top: var(--bar-height); box-sizing: border-box; }

        .bead {
            width: var(--bead-size);
            height: var(--bead-size);
            border-radius: 50%;
            cursor: pointer;
            z-index: 2;
            position: relative;
            margin: var(--bead-margin) 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .earth-bead { background-color: var(--earth-bead-color); }
        .heaven-bead { background-color: var(--heaven-bead-color); }
        
        .bead.highlight {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--highlight-color);
        }
        
        .upper-deck .bead.active { transform: translateY(var(--bead-move-distance)); }
        .lower-deck .bead.active { transform: translateY(calc(-1 * var(--bead-move-distance))); }
        
        @media (max-width: 600px) {
            :root {
                --bead-size: 35px;
                --bead-move-distance: 40px; 
            }
            .result-display { font-size: 2em; }
        }
    </style>
</head>
<body>

    <div id="app-controls">
        <button id="add-abacus-btn" class="control-btn">+</button>
        <button id="remove-abacus-btn" class="control-btn">-</button>
    </div>

    <div id="abacus-collection">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addBtn = document.getElementById('add-abacus-btn');
            const removeBtn = document.getElementById('remove-abacus-btn');
            const collection = document.getElementById('abacus-collection');
            const NUM_RODS = 13;

            /**
             * This function creates a complete, independent abacus instance.
             */
            function createAbacusInstance() {
                // --- 1. Create the DOM elements for this instance ---
                const abacusContainer = document.createElement('div');
                abacusContainer.className = 'abacus-container';

                const resultDisplay = document.createElement('div');
                resultDisplay.className = 'result-display';
                resultDisplay.textContent = '0';

                const abacusFrame = document.createElement('div');
                abacusFrame.className = 'abacus-frame';
                abacusFrame.innerHTML = '<div class="center-bar"></div>'; // Add center bar

                // --- Helper function to create a single bead ---
                const createBead = (value, rod, index, isHeavenBead) => {
                    const bead = document.createElement('div');
                    bead.className = 'bead ' + (isHeavenBead ? 'heaven-bead' : 'earth-bead');
                    bead.dataset.value = value;
                    bead.dataset.rod = rod;
                    bead.dataset.index = index;
                    return bead;
                };

                // --- Create all rods and beads for this instance ---
                for (let i = 0; i < NUM_RODS; i++) {
                    const rod = document.createElement('div');
                    rod.className = 'rod';

                    const upperDeck = document.createElement('div');
                    upperDeck.className = 'upper-deck';
                    upperDeck.appendChild(createBead(5, i, 0, true));
                    
                    const lowerDeck = document.createElement('div');
                    lowerDeck.className = 'lower-deck';
                    for (let j = 0; j < 4; j++) {
                        lowerDeck.appendChild(createBead(1, i, j, false));
                    }

                    rod.appendChild(upperDeck);
                    rod.appendChild(lowerDeck);
                    abacusFrame.appendChild(rod);
                }

                // --- 2. Define instance-specific functions ---
                const updateCalculation = () => {
                    let totalValue = 0n;
                    for (let i = 0; i < NUM_RODS; i++) {
                        const rod = abacusFrame.querySelectorAll('.rod')[i];
                        let rodValue = 0;
                        rod.querySelectorAll('.bead.active').forEach(bead => {
                            rodValue += parseInt(bead.dataset.value, 10);
                        });
                        const placeValue = 10n ** BigInt(NUM_RODS - 1 - i);
                        totalValue += BigInt(rodValue) * placeValue;
                    }
                    resultDisplay.textContent = totalValue.toLocaleString();
                };
                
                const handleBeadTap = (tappedBead) => {
                    if (tappedBead.classList.contains('heaven-bead')) {
                        tappedBead.classList.toggle('active');
                    } else {
                        const rod = tappedBead.closest('.rod');
                        const earthBeads = Array.from(rod.querySelectorAll('.earth-bead'));
                        const tappedIndex = parseInt(tappedBead.dataset.index, 10);
                        
                        if (tappedBead.classList.contains('active')) {
                            const beadBelow = earthBeads[tappedIndex + 1];
                            if (!beadBelow || !beadBelow.classList.contains('active')) {
                                tappedBead.classList.remove('active');
                            }
                        } else {
                            const beadAbove = earthBeads[tappedIndex - 1];
                            if (!beadAbove || beadAbove.classList.contains('active')) {
                                tappedBead.classList.add('active');
                            }
                        }
                    }
                    updateCalculation();
                };

                // --- 3. Attach event listener to this instance's frame ---
                abacusFrame.addEventListener('touchstart', (e) => {
                    if (e.target.classList.contains('bead')) {
                        e.preventDefault();
                        const bead = e.target;
                        bead.classList.add('highlight');
                        const handleEnd = () => {
                            bead.classList.remove('highlight');
                            handleBeadTap(bead);
                            bead.removeEventListener('touchend', handleEnd);
                            bead.removeEventListener('touchcancel', handleEnd);
                        };
                        bead.addEventListener('touchend', handleEnd);
                        bead.addEventListener('touchcancel', handleEnd);
                    }
                });

                // --- 4. Assemble and append the new abacus to the page ---
                abacusContainer.appendChild(resultDisplay);
                abacusContainer.appendChild(abacusFrame);
                collection.appendChild(abacusContainer);
            }

            // --- Main event listeners for the control buttons ---
            addBtn.addEventListener('click', createAbacusInstance);

            removeBtn.addEventListener('click', () => {
                if (collection.lastChild) {
                    collection.removeChild(collection.lastChild);
                }
            });

            // --- Start with one abacus on the page ---
            createAbacusInstance();
        });
    </script>

</body>
</html>
