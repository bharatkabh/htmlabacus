<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interactive Abacus Tutor</title>
    <style>
        :root {
            --background-color: #f0f2f5;
            --frame-color: #ffffff;
            --rod-color: #d1d5db;
            --bar-color: #4b5563;
            --earth-bead-color: #2563eb;
            --heaven-bead-color: #16a34a;
            --text-color: #111827;
            
            /* Tutorial Colors */
            --tutorial-focus-color: #f59e0b; /* Amber 500 */
            --tutorial-context-color: #38bdf8; /* Sky 400 */
            
            --bead-size: 40px;
            --bar-height: 20px;
            --bead-move-distance: 48px;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px 10px;
            overflow-y: auto;
            touch-action: manipulation;
        }
        
        #app-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            min-width: 50px;
            height: 50px;
            padding: 0 20px;
            border-radius: 25px;
            border: 2px solid var(--bar-color);
            background-color: var(--frame-color);
            color: var(--bar-color);
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.15s ease, background-color 0.15s ease;
        }
        
        .control-btn:hover { background-color: #e5e7eb; }
        .control-btn:active { transform: scale(0.95); }
        .control-btn.circle { width: 50px; padding: 0; border-radius: 50%; }

        #abacus-collection { display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .abacus-container { display: flex; flex-direction: column; align-items: center; box-sizing: border-box; width: 100%; max-width: 800px; }

        .result-display {
            background-color: var(--frame-color);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 2.5em;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 15px;
            width: 100%;
            max-width: 600px;
            text-align: right;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            letter-spacing: 2px;
            box-sizing: border-box;
        }

        .abacus-frame { display: flex; justify-content: space-around; background-color: var(--frame-color); border: 2px solid #e5e7eb; border-radius: 16px; padding: 20px 10px; width: 100%; height: 320px; position: relative; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .center-bar { position: absolute; width: 100%; height: var(--bar-height); background-color: var(--bar-color); top: 30%; left: 0; z-index: 1; border-radius: 6px; }
        .rod { display: flex; flex-direction: column; justify-content: space-between; align-items: center; width: 6px; height: 100%; background-color: var(--rod-color); border-radius: 3px; position: relative; }
        
        .upper-deck, .lower-deck { display: flex; flex-direction: column; }
        .upper-deck { height: 30%; justify-content: flex-start; }
        .lower-deck { height: 70%; justify-content: flex-end; padding-top: var(--bar-height); box-sizing: border-box; }

        .bead {
            width: var(--bead-size);
            height: var(--bead-size);
            border-radius: 50%;
            cursor: pointer;
            z-index: 2;
            position: relative;
            margin: 5px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
        }
        
        .earth-bead { background-color: var(--earth-bead-color); }
        .heaven-bead { background-color: var(--heaven-bead-color); }
        .bead.highlight { transform: scale(1.1); }
        
        .bead.tutorial-focus { background-color: var(--tutorial-focus-color) !important; transform: scale(1.15); }
        .bead.tutorial-context { background-color: var(--tutorial-context-color) !important; }

        .upper-deck .bead.active { transform: translateY(var(--bead-move-distance)); }
        .lower-deck .bead.active { transform: translateY(calc(-1 * var(--bead-move-distance))); }

        .instruction-panel {
            display: none;
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
            background-color: var(--frame-color);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 2px solid #e5e7eb;
            box-sizing: border-box;
        }
        .instruction-panel h3 { margin: 0 0 10px; color: var(--text-color); }
        .instruction-panel p { margin: 0; font-size: 1.1em; line-height: 1.5; color: #374151; }
        .tutorial-nav { display: none; margin-top: 10px; gap: 15px; justify-content: flex-end; }
        .tutorial-nav button { background-color: var(--earth-bead-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; }
        .tutorial-nav button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .tutorial-nav .exit-btn { background-color: #ef4444; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--frame-color); padding: 20px; border-radius: 15px;
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content ul { list-style: none; padding: 0; }
        .modal-content li button {
            width: 100%; background: none; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; margin-bottom: 10px; text-align: left; font-size: 1.1em;
            cursor: pointer; transition: background-color 0.2s ease;
        }
        .modal-content li button:hover { background-color: #f0f2f5; }
        
        @media (max-width: 600px) {
            :root { --bead-size: 35px; --bead-move-distance: 40px; }
            .result-display { font-size: 2em; }
        }
    </style>
</head>
<body>

    <div id="app-controls">
        <button id="examples-btn" class="control-btn">Examples</button>
        <button id="add-abacus-btn" class="control-btn circle">+</button>
        <button id="remove-abacus-btn" class="control-btn circle">-</button>
    </div>

    <div id="abacus-collection"></div>

    <div id="examples-modal" class="modal">
        <div class="modal-content">
            <h2>Abacus Tutorials</h2>
            <ul id="examples-list">
                <li><button data-tutorial="represent-numbers">1. How to Represent Numbers</button></li>
                <li><button data-tutorial="represent-decimals">2. How to Represent Decimals</button></li>
                <li><button data-tutorial="addition">3. How to Do Addition</button></li>
                <li><button data-tutorial="subtraction">4. How to Do Subtraction</button></li>
                <li><button data-tutorial="multi-1-digit">5. Multiplication (1-Digit)</button></li>
                <li><button data-tutorial="multi-2-digit">6. Multiplication (2-Digit)</button></li>
                <li><button data-tutorial="multi-3-digit">7. Multiplication (3-Digit)</button></li>
                <li><button data-tutorial="div-1-digit">8. Division (1-Digit)</button></li>
                <li><button data-tutorial="div-2-digit">9. Division (2-Digit)</button></li>
                <li><button data-tutorial="sqrt-4-digit">10. Square Root (4-Digit)</button></li>
            </ul>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const addBtn = document.getElementById('add-abacus-btn');
        const removeBtn = document.getElementById('remove-abacus-btn');
        const collection = document.getElementById('abacus-collection');
        const examplesBtn = document.getElementById('examples-btn');
        const examplesModal = document.getElementById('examples-modal');
        const examplesList = document.getElementById('examples-list');
        const NUM_RODS = 13;

        const TUTORIALS = {
            'represent-numbers': { title: 'Representing the Number 472', interactive: true, steps: [ /* ... same steps ... */ { instruction: 'First, we represent 4 in the hundreds column. Since 4 is less than 5, we use the lower beads. Move the top 4 earth beads up.', state: '000', focus: [{ rod: 10, type: 'earth', count: 4 }] }, { instruction: 'Next, we represent 7 in the tens column. For 7, we use the heaven bead (5) and two earth beads (2). Move the heaven bead down.', state: '400', focus: [{ rod: 11, type: 'heaven', count: 1 }] }, { instruction: 'Now add 2 to the 5. Move two earth beads up in the tens column.', state: '450', focus: [{ rod: 11, type: 'earth', count: 2 }] }, { instruction: 'Finally, we represent 2 in the ones column. Move two earth beads up.', state: '470', focus: [{ rod: 12, type: 'earth', count: 2 }] }, { instruction: 'And there you have it! The abacus now shows 472. You can exit the tutorial or go back through the steps.', state: '472', focus: [] }] },
            'addition': { title: 'Addition: 128 + 351', interactive: true, steps: [ /* ... same steps ... */ { instruction: 'First, set the number 128 on the abacus, starting from the right.', state: '128', focus: [] }, { instruction: 'Now, let\'s add 351, starting from the left (the hundreds). Add 3 to the hundreds column (1+3=4).', state: '128', focus: [{ rod: 10, type: 'earth', count: 3 }] }, { instruction: 'Next, add 5 to the tens column (2+5=7). Use the heaven bead.', state: '428', focus: [{ rod: 11, type: 'heaven', count: 1 }] }, { instruction: 'Finally, add 1 to the ones column (8+1=9).', state: '478', focus: [{ rod: 12, type: 'earth', count: 1 }] }, { instruction: 'The result is 479! The abacus is great for visualizing addition.', state: '479', focus: [] }] },
            'subtraction': { title: 'Subtraction: 96 - 42', interactive: true, steps: [ /* ... same steps ... */ { instruction: 'First, set the number 96 on the abacus.', state: '96', focus: [] }, { instruction: 'Now, let\'s subtract 42, starting from the left (the tens). Subtract 4 from the tens column (9-4=5). Move 4 earth beads down.', state: '96', focus: [{ rod: 11, type: 'earth', count: 4, action: 'remove' }] }, { instruction: 'Next, subtract 2 from the ones column (6-2=4).', state: '56', focus: [{ rod: 12, type: 'earth', count: 2, action: 'remove' }] }, { instruction: 'The result is 54! Subtraction is just as intuitive as addition.', state: '54', focus: [] }] },
            'represent-decimals': { title: 'Representing Decimals', interactive: false, text: `To represent decimals, you designate a rod as the "units" rod. All rods to its right become decimal places. For example, to show **12.34**, you would:<br>1. Set '1' on the tens rod.<br>2. Set '2' on the units rod.<br>3. Set '3' on the next rod to the right (tenths place).<br>4. Set '4' on the following rod (hundredths place).<br>The abacus itself doesn't have a decimal point; you just have to remember where you placed it.` },
            'multi-1-digit': { title: 'Multiplication: 23 x 4', interactive: false, text: `Let's multiply 23 x 4.<br>1. Set the multiplicand (23) on the left side of the abacus (e.g., rods A, B).<br>2. Set the multiplier (4) on the right side (e.g., rod M).<br>3. Multiply the first digit of 23 (which is 2) by 4. 2x4=8. Set 08 on rods C, D.<br>4. Clear the 2 from rod A.<br>5. Multiply the second digit of 23 (which is 3) by 4. 3x4=12. Add 12 to rods D, E. Rod D becomes 8+1=9, rod E becomes 2.<br>6. Clear the 3 from rod B.<br>The answer is **92**.` },
            'multi-2-digit': { title: 'Advanced Multiplication (2-Digit)', interactive: false, text: 'This involves multiplying each digit of the first number by each digit of the second, and carefully placing the results in the correct columns before summing them up. It requires careful bookkeeping of which rods are being used.' },
            'multi-3-digit': { title: 'Advanced Multiplication (3-Digit)', interactive: false, text: 'Similar to 2-digit multiplication but with more steps. For ABC x DEF, you calculate AxD, BxD, CxD, then AxE, BxE, CxE, and so on, adding each partial product to the correct rods.' },
            'div-1-digit': { title: 'Division (1-Digit)', interactive: false, text: 'Division is like reverse multiplication. To divide 92 by 4, you set 92 on the abacus. Ask "How many 4s in 9?". The answer is 2. Place 2 on a new rod. Subtract 2x4=8 from the 9, leaving 1. You now have 12. "How many 4s in 12?". The answer is 3. Place 3 next to the 2. The answer is 23.' },
            'div-2-digit': { title: 'Division (2-Digit)', interactive: false, text: 'This is an advanced technique involving estimation and correction. To divide 1368 by 57, you would estimate how many times 5 goes into 13, place that digit, multiply back, subtract, and adjust if necessary.' },
            'sqrt-4-digit': { title: 'Square Root (4-Digit)', interactive: false, text: 'The "extraction of square root" method is very advanced. For a number like 1225, you group it into pairs (12 25). Find the largest square less than the first pair (12), which is 3 (3x3=9). 3 is the first digit of your answer. Subtract 9 from 12, leaving 3. Bring down the next pair (25) to make 325. Double your current answer (3x2=6) and find a digit X such that 6X * X is close to 325. In this case, X=5 (65x5=325). The answer is 35.' }
        };

        let abacusInstances = [];

        function createAbacusInstance() {
            const abacusContainer = document.createElement('div');
            abacusContainer.className = 'abacus-container';
            const resultDisplay = document.createElement('div');
            resultDisplay.className = 'result-display'; resultDisplay.textContent = '0';
            const abacusFrame = document.createElement('div');
            abacusFrame.className = 'abacus-frame'; abacusFrame.innerHTML = '<div class="center-bar"></div>';
            const instructionPanel = document.createElement('div');
            instructionPanel.className = 'instruction-panel';
            const tutorialNav = document.createElement('div');
            tutorialNav.className = 'tutorial-nav';
            
            let tutorial = null;
            let currentStep = 0;

            const getBeadElement = (rod, type, index) => {
                const rodEl = abacusFrame.querySelectorAll('.rod')[rod];
                if (!rodEl) return null;
                return rodEl.querySelectorAll(`.${type}-bead`)[index];
            };

            const setBeadsToNumber = (numStr) => {
                const paddedStr = numStr.padStart(NUM_RODS, '0');
                abacusFrame.querySelectorAll('.bead').forEach(b => b.classList.remove('active'));
                for (let i = 0; i < NUM_RODS; i++) {
                    let digit = parseInt(paddedStr[i]);
                    if (digit >= 5) {
                        getBeadElement(i, 'heaven', 0)?.classList.add('active');
                        digit -= 5;
                    }
                    for (let j = 0; j < digit; j++) {
                        getBeadElement(i, 'earth', 3 - j)?.classList.add('active');
                    }
                }
                updateCalculation();
            };

            const clearTutorialHighlights = () => {
                abacusFrame.querySelectorAll('.bead').forEach(b => {
                    b.classList.remove('tutorial-focus', 'tutorial-context');
                });
            };
            
            // --- MODIFIED FUNCTION ---
            const renderTutorialStep = () => {
                const step = tutorial.steps[currentStep];
                clearTutorialHighlights();
                setBeadsToNumber(step.state);

                abacusFrame.querySelectorAll('.bead.active').forEach(b => b.classList.add('tutorial-context'));
                step.focus.forEach(f => {
                    if (f.type === 'heaven') {
                        getBeadElement(f.rod, 'heaven', 0)?.classList.add('tutorial-focus');
                    } else {
                        const beads = Array.from(abacusFrame.querySelectorAll('.rod')[f.rod].querySelectorAll('.earth-bead'));
                        const beadsToHighlight = f.action === 'remove' ?
                            beads.filter(b => b.classList.contains('active')).slice(0, f.count) :
                            beads.filter(b => !b.classList.contains('active')).slice(0, f.count);
                        beadsToHighlight.forEach(b => b.classList.add('tutorial-focus'));
                    }
                });

                // FIX: Now includes the main tutorial title.
                instructionPanel.innerHTML = `<h3>${tutorial.title} (Step ${currentStep + 1}/${tutorial.steps.length})</h3><p>${step.instruction}</p>`;
                tutorialNav.querySelector('.back-btn').disabled = currentStep === 0;
                tutorialNav.querySelector('.next-btn').disabled = currentStep === tutorial.steps.length - 1;
            };

            const playTutorial = (tutorialData) => {
                tutorial = tutorialData;
                currentStep = 0;
                instructionPanel.style.display = 'block';
                tutorialNav.style.display = 'flex';
                
                tutorialNav.querySelector('.back-btn').style.display = 'inline-block';
                tutorialNav.querySelector('.next-btn').style.display = 'inline-block';

                if (tutorial.interactive) {
                    renderTutorialStep();
                } else {
                    // FIX: This section now correctly displays the title for text-only examples.
                    instructionPanel.innerHTML = `<h3>${tutorial.title}</h3><p>${tutorial.text}</p>`;
                    tutorialNav.querySelector('.back-btn').style.display = 'none';
                    tutorialNav.querySelector('.next-btn').style.display = 'none';
                }
            };
            
            const exitTutorial = () => {
                tutorial = null;
                instructionPanel.style.display = 'none';
                tutorialNav.style.display = 'none';
                clearTutorialHighlights();
                setBeadsToNumber('0');
            };

            tutorialNav.innerHTML = `<button class="exit-btn">Exit</button><button class="back-btn">Back</button><button class="next-btn">Next</button>`;
            tutorialNav.querySelector('.exit-btn').onclick = exitTutorial;
            tutorialNav.querySelector('.back-btn').onclick = () => { if(currentStep > 0) { currentStep--; renderTutorialStep(); } };
            tutorialNav.querySelector('.next-btn').onclick = () => { if(currentStep < tutorial.steps.length - 1) { currentStep++; renderTutorialStep(); } };

            const updateCalculation = () => { 
                let total = 0n;
                abacusFrame.querySelectorAll('.rod').forEach((rod, i) => {
                    let val = 0;
                    rod.querySelectorAll('.bead.active').forEach(b => val += parseInt(b.dataset.value));
                    total += BigInt(val) * (10n ** BigInt(NUM_RODS - 1 - i));
                });
                resultDisplay.textContent = total.toLocaleString();
            };

            const handleBeadTap = (tappedBead) => {
                if (tutorial) return;
                if (tappedBead.classList.contains('heaven-bead')) { tappedBead.classList.toggle('active'); } 
                else {
                    const rod = tappedBead.closest('.rod'), beads = Array.from(rod.querySelectorAll('.earth-bead')), idx = parseInt(tappedBead.dataset.index);
                    if (tappedBead.classList.contains('active')) {
                        if (!beads[idx + 1] || !beads[idx + 1].classList.contains('active')) tappedBead.classList.remove('active');
                    } else {
                        if (!beads[idx - 1] || beads[idx - 1].classList.contains('active')) tappedBead.classList.add('active');
                    }
                }
                updateCalculation();
            };
            
            abacusFrame.addEventListener('touchstart', (e) => {
                if (e.target.classList.contains('bead')) {
                    e.preventDefault(); const bead = e.target;
                    if (tutorial) return;
                    bead.classList.add('highlight');
                    const end = () => { bead.classList.remove('highlight'); handleBeadTap(bead); bead.removeEventListener('touchend', end); bead.removeEventListener('touchcancel', end); };
                    bead.addEventListener('touchend', end); bead.addEventListener('touchcancel', end);
                }
            });

            for (let i = 0; i < NUM_RODS; i++) {
                const rod = document.createElement('div'); rod.className = 'rod';
                const up = document.createElement('div'); up.className = 'upper-deck'; up.appendChild(createBead(5, i, 0, true));
                const low = document.createElement('div'); low.className = 'lower-deck';
                for (let j = 0; j < 4; j++) { low.appendChild(createBead(1, i, j, false)); }
                rod.appendChild(up); rod.appendChild(low); abacusFrame.appendChild(rod);
            }
            function createBead(v,r,i,h) { const b=document.createElement('div'); b.className='bead '+(h?'heaven-bead':'earth-bead'); b.dataset.value=v;b.dataset.rod=r;b.dataset.index=i; return b; }
            
            abacusContainer.appendChild(resultDisplay);
            abacusContainer.appendChild(abacusFrame);
            abacusContainer.appendChild(instructionPanel);
            abacusContainer.appendChild(tutorialNav);
            collection.appendChild(abacusContainer);
            
            return { element: abacusContainer, playTutorial };
        }

        addBtn.addEventListener('click', () => abacusInstances.push(createAbacusInstance()));
        removeBtn.addEventListener('click', () => {
            if (collection.lastChild) {
                collection.removeChild(collection.lastChild);
                abacusInstances.pop();
            }
        });

        examplesBtn.addEventListener('click', () => examplesModal.style.display = 'flex');
        examplesModal.addEventListener('click', (e) => { if (e.target === examplesModal) examplesModal.style.display = 'none'; });
        examplesList.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const tutorialId = e.target.dataset.tutorial;
                if (!abacusInstances.length) {
                    abacusInstances.push(createAbacusInstance());
                }
                abacusInstances[0].playTutorial(TUTORIALS[tutorialId]);
                examplesModal.style.display = 'none';
            }
        });

        abacusInstances.push(createAbacusInstance());
    });
    </script>
</body>
</html>
